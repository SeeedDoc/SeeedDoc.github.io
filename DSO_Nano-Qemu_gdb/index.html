<html><head><meta name="viewport" content="width=device-width, initial-scale=1"><link href=//fonts.googleapis.com/css?family=Raleway:400,300,600 rel=stylesheet type=text/css><link rel="stylesheet" type="text/css" href="../common/css/normalize.css"><link rel="stylesheet" type="text/css" href="../common/css/skeleton.css"><link rel="stylesheet" type="text/css" href="../common/css/wiki.css"><script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script><title>DSO Nano/Qemu gdb</title><meta charset="utf-8"/></head><body><div class"container"><a href="../"><img src="../common/logo.png"/></a></div><div class="mw-content-ltr container" dir="ltr" id="mw-content-text" lang="en"><h1>DSO Nano/Qemu gdb</h1>
<h1>  Running STM32 code on the qemu emulator </h1>
<p>With the qemu emulator you can run and debug arm code without any arm processor!
</p><p>You can load the code onto the emulator, connect the gdb debugger and step through the code. Of course, peripherals, timers and other microcontroller components will not be emulated, but it is helpful for verifying some of the code.
</p><p>You will need to run the qemu-system-arm which is part of the QEMU project. On Debian/Ubuntu it is included in the qemu-system package (or qemu-kvm-extras in older versions).
</p>
<h2>  Building qemu-system-arm (optional) </h2>
<p>If there is no distribution packages for your system, or the packaged version is older than 0.13, it is recommended that you build it yourself:
</p>
<pre>wget <a href="http://download.savannah.gnu.org/releases/qemu/qemu-0.13.0.tar.gz">http://download.savannah.gnu.org/releases/qemu/qemu-0.13.0.tar.gz</a>
tar xzf qemu-0.13.0.tar.gz 
cd qemu-0.13.0
./configure --disable-kvm --enable-debug --target-list=arm-softmmu --audio-card-list= --audio-drv-list=
make
</pre>
<p>You can now run it directly from the arm-softmmu folder, unless you want to install it to e.g. /usr/local/bin.
</p>
<h2>  Note on STM32 support </h2>
<p>The STM32 microcontroller in the DSO Nano uses an ARM cortex-m3 core. The qemu-system-arm does not know the ROM (flash) layout of the STM32. In particular, it does not read out the stack and reset vector from the 0x08000000 address. But if your elf file correctly designates the reset handler as entry point, it will use this as the starting address. However you will have to set the stack pointer (sp) manually.
</p>
<h2>  Start the emulator </h2>
<p>Start the qemu emulator and its internal gdb server (-s option), loading your elf file as a "kernel":
</p>
<pre>qemu-system-arm -cpu cortex-m3 -S -s -singlestep -nographic -m 513 -kernel dso-lib.elf
</pre>
<p>The "-m 513" option makes a memory space that includes the 0x2000000 RAM addresses of the STM32.
</p><p>Start up gdb (the one from your ARM toolchain!) and connect to the qemu emulator: 
</p>
<pre>arm-none-eabi-gdb dso-lib.elf
(gdb) target extended-remote localhost:1234
(gdb) set $sp = 0x20005000
(gdb) where
</pre>
<p>You can now start stepping through the program, just some examples
</p>
<pre>(gdb) display/i $pc
(gdb) stepi
(gdb) next
(gdb) break main.c:23
(gdb) x/16wx 0x20000000 
(gdb) cont
(gdb) info reg
(gdb) info variables
(gdb) print *pProperty

</pre>
<h2>  Links </h2>
<ul><li> <a href="http://balau82.wordpress.com/2010/08/17/debugging-arm-programs-inside-qemu/">http://balau82.wordpress.com/2010/08/17/debugging-arm-programs-inside-qemu/</a>
</li><li> <a href="http://embdev.net/topic/129757">http://embdev.net/topic/129757</a>
</li></ul>
Copyright (c) 2008-2016 Seeed Development Limited (<a href="http://www.seeedstudio.com">www.seeedstudio.com</a> / <a href="http://www.seeed.cc">www.seeed.cc</a>)<h6>This static html page was created from http://www.seeedstudio.com/wiki</h6></div></body></html>