<html><head><meta name="viewport" content="width=device-width, initial-scale=1"><link href=//fonts.googleapis.com/css?family=Raleway:400,300,600 rel=stylesheet type=text/css><link rel="stylesheet" type="text/css" href="../common/css/normalize.css"><link rel="stylesheet" type="text/css" href="../common/css/skeleton.css"><link rel="stylesheet" type="text/css" href="../common/css/wiki.css"><script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script><title>DevDuino Sensor Node V4.0 (ATmega 328)</title><meta charset="utf-8"/></head><body><div class"container"><a href="../index.html"><img src="../common/logo.png"/></a></div><div class="mw-content-ltr container" dir="ltr" id="mw-content-text" lang="en"><h1>DevDuino Sensor Node V4.0 (ATmega 328)</h1><div class="thumb tright"><div class="thumbinner" style="width:302px;"><img src="img/DD_SN_4.0_rev_face.jpg" width="300"/> <div class="thumbcaption"></div></div></div>

<p>devDuino Sensor Node V 4 is a compact Arduino-compatible microcontroller and is designed to build wireless networks based on transceiver nRF24L01+. You can easily connect other sensors or actuators to this platform, to build your remote monitoring or controlling system. Unlike the version 1,2,3 is on board built-in sensor temperature and humidity.<br/>
</p><p>Model:<a href="http://www.seeedstudio.com/depot/devDuino-Sensor-Node-V4-ATmega-328-Integrated-temperature-humidity-sensor-p-2279.html">103990074</a>
</p><p><img src="img/Sn4.0top.jpg" width="440"/>
<img src="img/SN_4.0_face.jpg" width="340"/>
</p>
<h2>  Feature </h2>
<ul><li> Built on Arduino-compatible architecture
</li><li> Clock frequency - 16MHz (may be reduced to reduce energy consumption by up to 8MHz)
</li><li> Integrated temperature &amp; humidity sensor HTU21D (-40 ° C +125 ° C, accuracy of ± 2 ° C, Relative Humidity: 0-100%, accuracy ± 2%)
</li><li> ISP programming interface (recommended)
</li><li> Serial programming interface
</li><li> Built-in clock button
</li><li> Built-in LED green (user configurable)
</li><li> 3 GROVE-compatible connector: I2C, Analog, Digital
</li><li> Power from one element CR123A (not included)
</li><li> Dimensions 30 x 65 mm
</li></ul>
<h2>  Layout and schematics </h2>
<p><img src="img/Sn4-top.png" width="400"/>
<img src="img/Sn4-bottom.png" width="400"/>
</p><p><img src="img/Snv4.png" width="500"/>
</p><p><br/>
</p>
<h2>  Error silkscreen (Rev 1) </h2>
<p>In Rev 1 there is an error screen printing on photo shows how should be designated contacts. It is not critical and in some extent does not affect the operability of the device.
</p><p><img src="img/Snv4-err.png" width="400"/>
</p>
<h2>  Basic functionality </h2>
<p>In the basic version (without additional sensors) module can be used as a wireless sensor temperature and relative humidity (using built-in sensor HTU21D with level control battery (built-in microcontroller).
</p>
<h2>  Expansion Capabilities </h2>
<p>Basic functionality can be greatly expanded by connecting the various components <a href="//www.seeedstudio.com/depot/Grove-t-3.html?ref=top">GROVE</a> from Seeed Studio.
</p>
<h2>  Interfaces </h2>
<ul><li> A0, A1 - displayed on the terminal "Analog" (the other two pins in the connector - VCC and GND for sensor supply)
</li><li> D3, D5 - displayed on connector "Digital" (the other two pins in the connector - VCC and GND for sensor supply)
</li><li> A4 (SDA), A5 (SCL) - displayed on connector "I2C" (the other two pins in the connector - VCC and GND for sensor supply)
</li><li> Interface for connecting an RF-module nRF24L01 +:
<ul><li> D11 - RF_MOSI
</li><li> D12 - RF_MISO
</li><li> D13 - RF_SCK
</li><li> D8 - RF_CE
</li><li> D7 - RF_CSN
</li><li> D2 - RF_IRQ
</li></ul>
</li><li> D4 - Clock button
</li><li> D9 - LED
</li><li> HTU21D sensor connected to the bus i2c (pins A4 (SDA), A5 (SCL)).
</li></ul>
<h2>  Features Sensor Node </h2>
<h3>  Module Programming </h3>
<h4>  With the help of programmer based FT232RL (and such) </h4>
<p>By default, the standard boot stitched microcontroller Arduino, allowing to record the firmware in the module with the type of programmers <a href="//devicter.ru/goods/Foca-v2-1-FT232RL">FOCA v2.2</a>.
</p><p>Connecting the programmer via 5-pin (PROG) on the module (battery installed when programming is required - module receives power from the programmer)
</p><p><b>Warning!</b> Do not forget to set the programmer working voltage of 3.3V.
When flashing the bootloader via ISP, be sure to disconnect the wireless module nRF24L01 +.
</p><p>Just programmer can be used to debug (monitor port).
</p>
<h4>  Using ISP-Programmer </h4>
<p>If you want to get even further about 2K more memory for your sketch, you can use almost any ISP-Programmer for example, Arduino ISP (regular Arduino-compatible board and a standard example of the environment Arduino) or <a href="http://devicter.ru/goods/USBtinyISP-Arduino-bootloader-programmer">USBtinyISP</a>.
</p><p>Connecting programmer via 6-pin connector (ISP) on the module (battery installed when programming is required - module receives power from the programmer).
</p>
<h3>  Option module supply nRF24L01+ </h3>
<p>In the first case, to maximize the operating time of a battery should be fitted in use nRF24L01+ power saving mechanisms:
</p>
<pre>...

      radio.powerUp();  //turn the power on NRF24
      
      // sending data
      
      ...

      radio.powerDown();  //turn off the power on NRF24

...</pre>
<h3>  Job button </h3>
<p>Button connected to digital pin of D4 without external pull-up resistor. This connection is necessary to use the built-in pull-up resistor microcontroller.
</p><p>This is done as follows (in the example being polled button once 0.5s and if it is pressed - LED lights):
</p>
<pre>void setup (){
  // button
  pinMode(4, INPUT);
  // enable pull-up resistor
  digitalWrite(4, HIGH);

  // LED
  pinMode(9, OUTPUT);
}

void loop(){
  if(digitalRead(4) == LOW) {
    digitalWrite(9, HIGH);
  }
  else {
    digitalWrite(9, LOW);
  }
  delay(500);
}
</pre>
<h3>  Measurement voltage power </h3>
<p>Besides measuring the voltage at the voltage divider with a simple analogRead (A2), you can use more "advanced" way - use the built-in capabilities of the microcontroller.
</p><p>You can use the following universal function:
</p>
<pre>
long readVcc() {
  // Read 1.1V reference against AVcc
  // set the reference to Vcc and the measurement to the internal 1.1V reference
  #if defined(__AVR_ATmega32U4__) || defined(__AVR_ATmega1280__) || defined(__AVR_ATmega2560__)
    ADMUX = _BV(REFS0) | _BV(MUX4) | _BV(MUX3) | _BV(MUX2) | _BV(MUX1);
  #elif defined (__AVR_ATtiny24__) || defined(__AVR_ATtiny44__) || defined(__AVR_ATtiny84__)
    ADMUX = _BV(MUX5) | _BV(MUX0);
  #elif defined (__AVR_ATtiny25__) || defined(__AVR_ATtiny45__) || defined(__AVR_ATtiny85__)
    ADMUX = _BV(MUX3) | _BV(MUX2);
  #else
    ADMUX = _BV(REFS0) | _BV(MUX3) | _BV(MUX2) | _BV(MUX1);
  #endif  

  delay(75); // Wait for Vref to settle
  ADCSRA |= _BV(ADSC); // Start conversion
  while (bit_is_set(ADCSRA,ADSC)); // measuring

  uint8_t low  = ADCL; // must read ADCL first - it then locks ADCH  
  uint8_t high = ADCH; // unlocks both

  long result = (high&lt;&lt;8) | low;

  result = 1125300L / result; // Calculate Vcc (in mV); 1125300 = 1.1*1023*1000
  return result; // Vcc in millivolts
}
</pre>
<p>The function returns the voltage in millivolts.
</p>
<h3>  Features connector Digital </h3>
<p>In the present pin connector Digital D3. The peculiarity of its use is that this digital signal to the pins of the interrupt can be processed (INT1).
</p>
<h3>  Getting more time working Sensor Node </h3>
<p>To ensure longer battery module from one battery can reduce the frequency of the microcontroller to 1MHz and lower "threshold" voltage at which it will start to 1.8V. 
</p><p>This is done by adding the following section in the file boards.txt IDE Arduino:
</p>
<pre>
s328o1.name=Sensor328p (int1MHz, 1.8V)

s328o1.upload.protocol=arduino
s328o1.upload.maximum_size=30720
s328o1.upload.speed=19200

s328o1.bootloader.low_fuses=0x62
s328o1.bootloader.high_fuses=0xda
s328o1.bootloader.extended_fuses=0x06
s328o1.bootloader.path=atmega

s328o1.bootloader.file=ATmegaBOOT_168_atmega328_pro_8MHz.hex

#s328o8.bootloader.file=ATmegaBOOT_168_atmega328.hex

s328o1.bootloader.unlock_bits=0x3F
s328o1.bootloader.lock_bits=0x0F

s328o1.build.mcu=atmega328p
s328o1.build.f_cpu=1000000L
s328o1.build.core=arduino
s328o1.build.variant=standard
</pre>
<p>After adding this code to the appropriate file (and restarting the Arduino) in the list of available cards will be a new line: Sensor328 (int1MHz, 1.8V)
</p><p><b>Warning!</b> Fuse bits specified in the file boards.txt and defining modes of microcontroller sewn Arduino environment only when writing the bootloader (but not the firmware of the microcontroller).
</p><p>To correct fuse bits without changing the boot loader can be used, for example <a href="http://sourceforge.net/projects/avrdude-gui/">avrdude GUI</a>
</p>
<h2>  Libraries </h2>
<h3>  Necessary libraries </h3>
<p>To use the Sensor Node requires the following libraries:
</p>
<ul><li> Working with the transceiver nRF24L01+ - <a href="https://github.com/maniacbug/RF24/archive/master.zip">RF24</a>
</li><li> Working with a sensor HTU21D - <a href="https://github.com/sparkfun/HTU21D_Breakout/archive/master.zip">HTU21D</a>
</li></ul>
<p>Requires the libraries that are used at work RF24:
</p>
<ul><li> SPI
</li><li> Wire
</li></ul>
<ul><li> You must use the library from - <a href="https://github.com/mysensors/Arduino/tree/master">www.mysensors.org</a>
</li></ul>
<p>Software debugging and use
</p>
<ul><li> For Windows (GUI) - <a href="http://www.mysensors.org/controller/myscontroller">MYSController</a>
</li><li> For other OS - <a href="http://www.mycontroller.org/#/home">MyController.org</a>
</li></ul>
<p>API 
</p>
<ul><li> MySensors Arduino Library <a href="http://www.mysensors.org/download/sensor_api_15">(v1.5)</a>
</li></ul>
<h3>  Features using libraries </h3>
<p>Library has used examples of them just to understand how it works.
</p><p>Initialization RF-module as follows:
</p>
<pre>...

//RF24 radio(CE,CSN);
RF24 radio(8,7);

...</pre>
<h3>  Demo code </h3>
<div class="mw-geshi mw-code mw-content-ltr container" dir="ltr"><div class="arduino source-arduino"><pre class="de1"> 
<span class="co2">#include &lt;SPI.h&gt;</span>
<span class="co2">#include "RF24.h"</span>
<span class="co2">#include &lt;Wire.h&gt;</span>
<span class="co2">#include "HTU21D.h"</span>
 
<span class="co2">#include &lt;avr/sleep.h&gt;</span>
<span class="co2">#include &lt;avr/wdt.h&gt;</span>
 
<span class="co2">#define CNT 30 // количество циклов по 8 секунд между "посылками" (30 = 4 минуты между посылками)</span>
<span class="kw4">int</span> count<span class="sy4">;</span>    <span class="co1">//переменная для счётчика циклов</span>
<span class="kw4">volatile</span> <span class="kw4">boolean</span> wdt_tripped<span class="sy1">=</span><span class="nu0">1</span><span class="sy4">;</span>
 
<span class="co1">// описание параметров модуля</span>
<span class="co2">#define SID 500                        // идентификатор датчика Внешний 1</span>
<span class="co2">#define NumSensors 4                   // количество сенсоров (и еще одно обязательное занчение - имя датчика)</span>
 
<span class="kw4">boolean</span> <span class="kw3">mode</span> <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span> <span class="co1">// 0 - нормальный режим (редко отправляем данные и не моргаем), </span>
                  <span class="co1">//1 - тестовый режим (данные отправляем раз в 8 секунд и моргаем светодиодом)</span>
 
<span class="co1">/////////////////////////////////////////////////////////////////////////////</span>
 
<span class="co1">// создаём структуру для передачи значений</span>
<span class="kw4">typedef</span> <span class="kw4">struct</span><span class="br0">{</span>         
  <span class="kw4">int</span> SensorID<span class="sy4">;</span>        <span class="co1">// идентификатор датчика</span>
  <span class="kw4">int</span> ParamID<span class="sy4">;</span>         <span class="co1">// идентификатор параметра </span>
  <span class="kw4">float</span> ParamValue<span class="sy4">;</span>    <span class="co1">// значение параметра</span>
  <span class="kw4">char</span> Comment<span class="br0">[</span><span class="nu0">16</span><span class="br0">]</span><span class="sy4">;</span>    <span class="co1">// комментарий</span>
<span class="br0">}</span>
Message<span class="sy4">;</span>
 
<span class="co2">#define LED 9</span>
<span class="co2">#define BUTTON 4</span>
 
<span class="co1">// создаем структуру для описания параметров</span>
<span class="kw4">typedef</span> <span class="kw4">struct</span><span class="br0">{</span>
  <span class="kw4">float</span> Value<span class="sy4">;</span>         <span class="co1">// значение </span>
  <span class="kw4">char</span> Note<span class="br0">[</span><span class="nu0">16</span><span class="br0">]</span><span class="sy4">;</span>       <span class="co1">// комментарий</span>
<span class="br0">}</span> 
Parameter<span class="sy4">;</span>
<span class="kw4">int</span> tests<span class="sy1">=</span><span class="nu0">0</span><span class="sy4">;</span>
<span class="co1">/////////////////////////////////////////////////////////////////////////////</span>
 
Parameter MySensors<span class="br0">[</span>NumSensors<span class="sy2">+</span><span class="nu0">1</span><span class="br0">]</span> <span class="sy1">=</span> <span class="br0">{</span>    <span class="co1">// описание датчиков (и первичная инициализация)</span>
  NumSensors, <span class="st0">"SN4 (in&amp;out)"</span>,            <span class="co1">// в поле "комментарий" указываем пояснительную информацию о датчике и количество сенсоров</span>
  <span class="nu0">0</span>, <span class="st0">"Temp, C"</span>,                        <span class="co1">// температура со встроенного датчика</span>
  <span class="nu0">0</span>, <span class="st0">"Hum, %"</span>,                        <span class="co1">// относительная влажность со встроенного датчика</span>
  <span class="nu0">0</span>, <span class="st0">"BATT, Flag"</span>,                       <span class="co1">// статус того, что батарейка в порядке (0 - "мертвая", 1 - "живая")</span>
  <span class="nu0">0</span>, <span class="st0">"VCC, V"</span>,                           <span class="co1">// напряжение питания (по внутренним данным МК)</span>
<span class="br0">}</span><span class="sy4">;</span>
 
Message sensor<span class="sy4">;</span> 
 
<span class="co1">/////////////////////////////////////////////////////////////////////////////</span>
 
<span class="co1">//RF24 radio(CE,CSN);</span>
RF24 radio<span class="br0">(</span><span class="nu0">8</span>,<span class="nu0">7</span><span class="br0">)</span><span class="sy4">;</span>
 
<span class="co1">// выберем две "трубы" (выбираем свои)</span>
<span class="kw4">const</span> uint64_t pipes<span class="br0">[</span><span class="nu0">2</span><span class="br0">]</span> <span class="sy1">=</span> <span class="br0">{</span> 
  0xF0F0F0F0A1LL, 0xF0F0F0F0A2LL <span class="br0">}</span><span class="sy4">;</span>
 
<span class="co1">/////////////////////////////////////////////////////////////////////////////</span>
 
HTU21D myHumidity<span class="sy4">;</span>
 
<span class="co1">//режим сна для МК</span>
<span class="kw4">void</span> system_sleep<span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
  <span class="kw3">delay</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span><span class="sy4">;</span>                            <span class="co1">// Wait for serial traffic</span>
  _SFR_BYTE<span class="br0">(</span>ADCSRA<span class="br0">)</span> <span class="sy3">&amp;</span><span class="sy1">=</span> ~_BV<span class="br0">(</span>ADEN<span class="br0">)</span><span class="sy4">;</span>     <span class="co1">// Switch ADC off</span>
  set_sleep_mode<span class="br0">(</span>SLEEP_MODE_PWR_DOWN<span class="br0">)</span><span class="sy4">;</span>
  sleep_enable<span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
  sleep_mode<span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>                        <span class="co1">// System sleeps here</span>
  sleep_disable<span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
  _SFR_BYTE<span class="br0">(</span>ADCSRA<span class="br0">)</span> <span class="sy3">|</span><span class="sy1">=</span> _BV<span class="br0">(</span>ADEN<span class="br0">)</span><span class="sy4">;</span>      <span class="co1">// Switch ADC on</span>
<span class="br0">}</span>
 
<span class="kw4">void</span> wdt_interrupt_mode<span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
  wdt_reset<span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
  WDTCSR <span class="sy3">|</span><span class="sy1">=</span> _BV<span class="br0">(</span>WDIE<span class="br0">)</span><span class="sy4">;</span> <span class="co1">// Restore WDT interrupt mode</span>
<span class="br0">}</span>
 
ISR<span class="br0">(</span>WDT_vect<span class="br0">)</span> <span class="br0">{</span>
  wdt_tripped<span class="sy1">=</span><span class="nu0">1</span><span class="sy4">;</span>  <span class="co1">// set global volatile variable</span>
<span class="br0">}</span>
 
 
<span class="kw4">void</span> <span class="kw2">setup</span><span class="br0">(</span><span class="br0">)</span>
<span class="br0">{</span>
  wdt_disable<span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
  wdt_reset<span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
  wdt_enable<span class="br0">(</span>WDTO_8S<span class="br0">)</span><span class="sy4">;</span>   <span class="co1">//пробуждение каждые 8 сек</span>
  count <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
 
  <span class="co1">// светик </span>
  <span class="kw3">pinMode</span><span class="br0">(</span>LED, <span class="kw2">OUTPUT</span><span class="br0">)</span><span class="sy4">;</span>
 
 <span class="co1">// Инизиализация HTU21D </span>
  myHumidity.<span class="kw3">begin</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
 
  radio.<span class="kw3">begin</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
  <span class="co1">//radio.setPALevel(RF24_PA_HIGH);   // Уровень мощности (работает только с версией RF + PA)</span>
  radio.<span class="me1">setDataRate</span><span class="br0">(</span>RF24_250KBPS<span class="br0">)</span><span class="sy4">;</span>  <span class="co1">// Скорость передачи</span>
  radio.<span class="me1">setRetries</span><span class="br0">(</span><span class="nu0">15</span>,<span class="nu0">15</span><span class="br0">)</span><span class="sy4">;</span>
 
  <span class="co1">// номер канала, на котором работаем (подобрать свой)</span>
  radio.<span class="me1">setChannel</span><span class="br0">(</span><span class="nu0">100</span><span class="br0">)</span><span class="sy4">;</span>
 
  radio.<span class="me1">openWritingPipe</span><span class="br0">(</span>pipes<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span><span class="br0">)</span><span class="sy4">;</span>
  radio.<span class="me1">openReadingPipe</span><span class="br0">(</span><span class="nu0">1</span>,pipes<span class="br0">[</span><span class="nu0">1</span><span class="br0">]</span><span class="br0">)</span><span class="sy4">;</span>
 
  radio.<span class="me1">stopListening</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span> <span class="co1">// отключаем режим приёма</span>
 
  <span class="co1">// при старте включаем "тестовый" режим - данные отправляем часто и моргаем светодиодом</span>
  <span class="kw3">mode</span> <span class="sy1">=</span> <span class="nu0">1</span><span class="sy4">;</span>
<span class="br0">}</span>
 
<span class="kw4">void</span> <span class="kw2">loop</span><span class="br0">(</span><span class="kw4">void</span><span class="br0">)</span>
<span class="br0">{</span> 
  <span class="co1">//тут можно увеличить интервал времени между оправками данных по RF24 за счёт счётчика циклов</span>
  wdt_interrupt_mode<span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
 
  <span class="kw1">if</span> <span class="br0">(</span>wdt_tripped<span class="br0">)</span> <span class="br0">{</span>
    count<span class="sy2">++</span><span class="sy4">;</span>
    wdt_tripped <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
 
    <span class="co1">// отправим данные, если уже "пора" </span>
    <span class="kw1">if</span> <span class="br0">(</span>count <span class="sy1">==</span> <span class="br0">(</span><span class="br0">(</span><span class="kw3">mode</span><span class="sy1">==</span><span class="nu0">1</span><span class="br0">)</span> <span class="sy4">?</span> <span class="br0">(</span>count<span class="br0">)</span> <span class="sy4">:</span> <span class="br0">(</span>CNT<span class="br0">)</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
      calculateValue<span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
      <span class="co1">// зажжем светодиод</span>
      <span class="kw1">if</span> <span class="br0">(</span><span class="kw3">mode</span> <span class="sy1">==</span> <span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw3">digitalWrite</span><span class="br0">(</span>LED, <span class="kw2">HIGH</span><span class="br0">)</span><span class="sy4">;</span>
      <span class="br0">}</span>
 
      radio.<span class="kw3">powerUp</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>  <span class="co1">//подаём питание на NRF24</span>
      <span class="kw3">delay</span><span class="br0">(</span><span class="nu0">20</span><span class="br0">)</span><span class="sy4">;</span>
      <span class="kw1">for</span> <span class="br0">(</span><span class="kw4">int</span> i<span class="sy1">=</span><span class="nu0">1</span><span class="sy4">;</span> i<span class="sy1">&lt;=</span>NumSensors<span class="sy4">;</span> i<span class="sy2">++</span><span class="br0">)</span><span class="br0">{</span>
        sendSensorMessage<span class="br0">(</span>i<span class="br0">)</span><span class="sy4">;</span>
      <span class="br0">}</span>
      radio.<span class="kw3">powerDown</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span> <span class="co1">// отключаем питание RF24</span>
      <span class="kw3">delay</span><span class="br0">(</span><span class="nu0">20</span><span class="br0">)</span><span class="sy4">;</span>
 
      count <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
      <span class="co1">// погасим светодиод</span>
      <span class="kw1">if</span> <span class="br0">(</span><span class="kw3">mode</span> <span class="sy1">==</span> <span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw3">digitalWrite</span><span class="br0">(</span>LED, <span class="kw2">LOW</span><span class="br0">)</span><span class="sy4">;</span>
      <span class="br0">}</span>
    <span class="br0">}</span>
  <span class="br0">}</span>
 
  <span class="kw1">if</span><span class="br0">(</span>tests<span class="sy1">&lt;</span><span class="nu0">10</span><span class="br0">)</span> <span class="br0">{</span>
    <span class="kw3">mode</span> <span class="sy1">=</span> <span class="nu0">1</span><span class="sy4">;</span>
    tests<span class="sy2">++</span><span class="sy4">;</span>
  <span class="br0">}</span>
  <span class="kw1">else</span> <span class="br0">{</span>
    <span class="kw3">mode</span> <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
  <span class="br0">}</span>
 
  <span class="co1">// спать!</span>
  system_sleep<span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>   <span class="co1">//МК засыпает</span>
<span class="br0">}</span>
 
 
<span class="co1">// функция вычисления всех значений датчиков</span>
<span class="kw4">void</span> calculateValue<span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
  <span class="co1">// код для получения данных</span>
 
   <span class="co1">// температура и влажность встроенного датчика (HTU21D)</span>
  MySensors<span class="br0">[</span><span class="nu0">1</span><span class="br0">]</span>.<span class="me1">Value</span> <span class="sy1">=</span> myHumidity.<span class="me1">readTemperature</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
  MySensors<span class="br0">[</span><span class="nu0">2</span><span class="br0">]</span>.<span class="me1">Value</span> <span class="sy1">=</span> myHumidity.<span class="me1">readHumidity</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
 
  <span class="co1">// если напряжение больше 2.67В - батарейка "живая" (1)</span>
  <span class="co1">// если меньше - "скоро помрет" (0)</span>
  MySensors<span class="br0">[</span><span class="nu0">3</span><span class="br0">]</span>.<span class="me1">Value</span> <span class="sy1">=</span> <span class="br0">(</span>MySensors<span class="br0">[</span><span class="nu0">4</span><span class="br0">]</span>.<span class="me1">Value</span> <span class="sy1">&gt;</span> <span class="nu16">2.67</span><span class="br0">)</span> <span class="sy4">?</span> <span class="nu0">1</span> <span class="sy4">:</span> <span class="nu0">0</span><span class="sy4">;</span> 
   <span class="co1">// напряжение питания</span>
  MySensors<span class="br0">[</span><span class="nu0">4</span><span class="br0">]</span>.<span class="me1">Value</span> <span class="sy1">=</span> <span class="br0">(</span><span class="br0">(</span><span class="kw4">float</span><span class="br0">)</span> readVcc<span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy2">/</span><span class="nu16">1000.0</span><span class="sy4">;</span>
 
  <span class="kw1">return</span><span class="sy4">;</span>
<span class="br0">}</span>
 
 
<span class="co1">// отправить сообщение (идентификатор параметра)</span>
<span class="kw4">void</span> sendSensorMessage<span class="br0">(</span><span class="kw4">int</span> ParamID<span class="br0">)</span> <span class="br0">{</span>
 
  <span class="co1">//подготовим данные в структуру для передачи</span>
  sensor.<span class="me1">SensorID</span> <span class="sy1">=</span> SID<span class="sy4">;</span>
  sensor.<span class="me1">ParamID</span> <span class="sy1">=</span> ParamID<span class="sy4">;</span>        
  sensor.<span class="me1">ParamValue</span> <span class="sy1">=</span> MySensors<span class="br0">[</span>ParamID<span class="br0">]</span>.<span class="me1">Value</span><span class="sy4">;</span>        
  <span class="kw3">memcpy</span><span class="br0">(</span><span class="sy3">&amp;</span>sensor.<span class="me1">Comment</span>,<span class="br0">(</span><span class="kw4">char</span><span class="sy2">*</span><span class="br0">)</span>MySensors<span class="br0">[</span>ParamID<span class="br0">]</span>.<span class="me1">Note</span>, <span class="nu0">16</span><span class="br0">)</span><span class="sy4">;</span>
 
  <span class="co1">//отправляем данные по RF24</span>
  <span class="kw4">bool</span> ok <span class="sy1">=</span> radio.<span class="kw3">write</span><span class="br0">(</span> <span class="sy3">&amp;</span>sensor, <span class="kw3">sizeof</span><span class="br0">(</span>sensor<span class="br0">)</span> <span class="br0">)</span><span class="sy4">;</span> 
 
  <span class="kw3">delay</span> <span class="br0">(</span><span class="nu0">20</span><span class="br0">)</span><span class="sy4">;</span> 
  <span class="kw1">return</span><span class="sy4">;</span>
<span class="br0">}</span>
 
<span class="kw4">long</span> readVcc<span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
  <span class="co1">// Read 1.1V reference against AVcc</span>
  <span class="co1">// set the reference to Vcc and the measurement to the internal 1.1V reference</span>
  <span class="co2">#if defined(__AVR_ATmega32U4__) || defined(__AVR_ATmega1280__) || defined(__AVR_ATmega2560__)</span>
    ADMUX <span class="sy1">=</span> _BV<span class="br0">(</span>REFS0<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX4<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX3<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX2<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX1<span class="br0">)</span><span class="sy4">;</span>
  <span class="co2">#elif defined (__AVR_ATtiny24__) || defined(__AVR_ATtiny44__) || defined(__AVR_ATtiny84__)</span>
    ADMUX <span class="sy1">=</span> _BV<span class="br0">(</span>MUX5<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX0<span class="br0">)</span><span class="sy4">;</span>
  <span class="co2">#elif defined (__AVR_ATtiny25__) || defined(__AVR_ATtiny45__) || defined(__AVR_ATtiny85__)</span>
    ADMUX <span class="sy1">=</span> _BV<span class="br0">(</span>MUX3<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX2<span class="br0">)</span><span class="sy4">;</span>
  <span class="co2">#else</span>
    ADMUX <span class="sy1">=</span> _BV<span class="br0">(</span>REFS0<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX3<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX2<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX1<span class="br0">)</span><span class="sy4">;</span>
  <span class="co2">#endif  </span>
 
  <span class="kw3">delay</span><span class="br0">(</span><span class="nu0">75</span><span class="br0">)</span><span class="sy4">;</span> <span class="co1">// Wait for Vref to settle</span>
  ADCSRA <span class="sy3">|</span><span class="sy1">=</span> _BV<span class="br0">(</span>ADSC<span class="br0">)</span><span class="sy4">;</span> <span class="co1">// Start conversion</span>
  <span class="kw1">while</span> <span class="br0">(</span>bit_is_set<span class="br0">(</span>ADCSRA,ADSC<span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span> <span class="co1">// measuring</span>
 
  uint8_t low  <span class="sy1">=</span> ADCL<span class="sy4">;</span> <span class="co1">// must read ADCL first - it then locks ADCH  </span>
  uint8_t high <span class="sy1">=</span> ADCH<span class="sy4">;</span> <span class="co1">// unlocks both</span>
 
  <span class="kw4">long</span> result <span class="sy1">=</span> <span class="br0">(</span>high<span class="sy1">&lt;&lt;</span><span class="nu0">8</span><span class="br0">)</span> <span class="sy3">|</span> low<span class="sy4">;</span>
 
  result <span class="sy1">=</span> <span class="nu0">1125300L</span> <span class="sy2">/</span> result<span class="sy4">;</span> <span class="co1">// Calculate Vcc (in mV); 1125300 = 1.1*1023*1000</span>
  <span class="kw1">return</span> result<span class="sy4">;</span> <span class="co1">// Vcc in millivolts</span>
<span class="br0">}</span></pre></div></div>
<h3>  Demo code (Working)</h3>
<div class="mw-geshi mw-code mw-content-ltr container" dir="ltr"><div class="arduino source-arduino"><pre class="de1"> 
<span class="coMULTI">/*
This sketch is for a DevDuino 4.0 
http://www.seeedstudio.com/depot/devDuino-Sensor-Node-V4-ATmega-328-Integrated-temperature-humidity-sensor-p-2279.html
and MySensors 1.5
 
 modified
 31 December 2015
 by greengo
 
*/</span>
 
<span class="co2">#include &lt;MySensor.h&gt; // Library of Mysensors.org (v 1.5)</span>
<span class="co2">#include &lt;SPI.h&gt;</span>
<span class="co2">#include "HTU21D.h"</span>
<span class="co2">#include &lt;Wire.h&gt;</span>
<span class="co2">#include &lt;RunningAverage.h&gt;</span>
 
<span class="co1">// Define a static node address, remove if you want auto address assignment</span>
<span class="co2">#define NODE_ADDRESS   4</span>
 
<span class="co1">// Uncomment the line below, to transmit battery voltage as a normal sensor value</span>
<span class="co2">#define BATT_SENSOR    3</span>
 
<span class="co2">#define RELEASE "1.1"</span>
 
<span class="co2">#define AVERAGES 2</span>
 
<span class="co1">// How many milli seconds between each measurement</span>
<span class="co2">#define MEASURE_INTERVAL 50000 //for Real Work 50 sec</span>
<span class="co1">//#define MEASURE_INTERVAL  10000 //for Debug 10 sec</span>
 
<span class="co1">// FORCE_TRANSMIT_INTERVAL, this number of times of wakeup, the sensor is forced to report all values to the controller</span>
<span class="co2">#define FORCE_TRANSMIT_INTERVAL 30 </span>
<span class="co1">//#define FORCE_TRANSMIT_INTERVAL 10 //for Debug </span>
 
<span class="co1">// LED blinks during data transmission. Greater battery energy consumption!</span>
<span class="co2">#define LED_BLINK_WAIT_TRANSMIT  </span>
 
<span class="co2">#define TEMP_TRANSMIT_THRESHOLD 0.5</span>
<span class="co2">#define HUMI_TRANSMIT_THRESHOLD 0.5</span>
 
<span class="co1">// Pin definitions</span>
<span class="co2">#define LED_PIN           9 // LED </span>
 
<span class="co1">// Child sensor ID's</span>
<span class="co2">#define CHILD_ID_TEMP  1</span>
<span class="co2">#define CHILD_ID_HUM   2</span>
 
MyTransportNRF24 transport<span class="br0">(</span><span class="nu0">8</span>, <span class="nu0">7</span><span class="br0">)</span><span class="sy4">;</span>
MySensor gw<span class="br0">(</span>transport<span class="br0">)</span><span class="sy4">;</span> 
 
<span class="kw4">int</span> oldBattPct <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
<span class="kw4">float</span> temp <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
 
MyMessage msgTemp<span class="br0">(</span>CHILD_ID_TEMP, V_TEMP<span class="br0">)</span><span class="sy4">;</span>
MyMessage msgHum<span class="br0">(</span>CHILD_ID_HUM, V_HUM<span class="br0">)</span><span class="sy4">;</span>
 
<span class="co2">#ifdef BATT_SENSOR</span>
MyMessage msgBatt<span class="br0">(</span>BATT_SENSOR, V_VOLTAGE<span class="br0">)</span><span class="sy4">;</span>
<span class="co2">#endif</span>
 
<span class="co1">// Global settings</span>
<span class="kw4">int</span> measureCount <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
<span class="kw4">int</span> sendBattery <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
<span class="kw4">boolean</span> highfreq <span class="sy1">=</span> <span class="kw2">true</span><span class="sy4">;</span>
<span class="kw4">boolean</span> transmission_occured <span class="sy1">=</span> <span class="kw2">false</span><span class="sy4">;</span>
 
HTU21D myHumidity<span class="sy4">;</span>
 
<span class="co1">// Storage of old measurements</span>
<span class="kw4">float</span> lastTemperature <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
<span class="kw4">int</span> lastHumidity <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
<span class="kw4">long</span> lastBattery <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
 
RunningAverage raHum<span class="br0">(</span>AVERAGES<span class="br0">)</span><span class="sy4">;</span>
 
<span class="coMULTI">/****************************************************
 * Setup code 
 ****************************************************/</span>
<span class="kw4">void</span> <span class="kw2">setup</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
 
  <span class="co1">// initialize digital pin 9 as an output.</span>
  <span class="kw3">pinMode</span><span class="br0">(</span>LED_PIN, <span class="kw2">OUTPUT</span><span class="br0">)</span><span class="sy4">;</span> 
 
  <span class="kw2">Serial</span>.<span class="kw3">begin</span><span class="br0">(</span><span class="nu0">115200</span><span class="br0">)</span><span class="sy4">;</span>
  <span class="kw2">Serial</span>.<span class="kw3">print</span><span class="br0">(</span>F<span class="br0">(</span><span class="st0">"devDuino SNv4"</span><span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span>
  <span class="kw2">Serial</span>.<span class="kw3">println</span><span class="br0">(</span>RELEASE<span class="br0">)</span><span class="sy4">;</span>
  <span class="kw2">Serial</span>.<span class="kw3">flush</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span> 
 
  <span class="kw3">digitalWrite</span><span class="br0">(</span>LED_PIN, <span class="kw2">HIGH</span><span class="br0">)</span><span class="sy4">;</span> 
 
<span class="co2">#ifdef NODE_ADDRESS</span>
  gw.<span class="kw3">begin</span><span class="br0">(</span><span class="kw2">NULL</span>, NODE_ADDRESS, <span class="kw2">false</span><span class="br0">)</span><span class="sy4">;</span>
<span class="co2">#else</span>
  gw.<span class="kw3">begin</span><span class="br0">(</span><span class="kw2">NULL</span>,AUTO,<span class="kw2">false</span><span class="br0">)</span><span class="sy4">;</span>
<span class="co2">#endif  </span>
 
myHumidity.<span class="kw3">begin</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span> 
 
  <span class="kw3">digitalWrite</span><span class="br0">(</span>LED_PIN, <span class="kw2">LOW</span><span class="br0">)</span><span class="sy4">;</span>
 
  <span class="kw2">Serial</span>.<span class="kw3">flush</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
  <span class="kw2">Serial</span>.<span class="kw3">println</span><span class="br0">(</span>F<span class="br0">(</span><span class="st0">" - Online!"</span><span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span>
  gw.<span class="me1">sendSketchInfo</span><span class="br0">(</span><span class="st0">"devDuino SNv4"</span>, RELEASE<span class="br0">)</span><span class="sy4">;</span> 
 
  gw.<span class="me1">present</span><span class="br0">(</span>CHILD_ID_TEMP,S_TEMP<span class="br0">)</span><span class="sy4">;</span> 
  gw.<span class="me1">present</span><span class="br0">(</span>CHILD_ID_HUM, S_HUM<span class="br0">)</span><span class="sy4">;</span> 
 
<span class="co2">#ifdef BATT_SENSOR</span>
  gw.<span class="me1">present</span><span class="br0">(</span>BATT_SENSOR, S_POWER<span class="br0">)</span><span class="sy4">;</span>
<span class="co2">#endif </span>
 
raHum.<span class="kw3">clear</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
 
sendTempHumidityMeasurements<span class="br0">(</span><span class="kw2">false</span><span class="br0">)</span><span class="sy4">;</span>
sendBattLevel<span class="br0">(</span><span class="kw2">false</span><span class="br0">)</span><span class="sy4">;</span>
 
<span class="br0">}</span>
<span class="coMULTI">/***********************************************
 *  Main loop function
 ***********************************************/</span>
<span class="kw4">void</span> <span class="kw2">loop</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
  measureCount <span class="sy2">++</span><span class="sy4">;</span>
  sendBattery <span class="sy2">++</span><span class="sy4">;</span>
  <span class="kw4">bool</span> forceTransmit <span class="sy1">=</span> <span class="kw2">false</span><span class="sy4">;</span>
  transmission_occured <span class="sy1">=</span> <span class="kw2">false</span><span class="sy4">;</span>
  <span class="kw1">if</span> <span class="br0">(</span><span class="br0">(</span>measureCount <span class="sy1">==</span> <span class="nu0">5</span><span class="br0">)</span> <span class="sy3">&amp;&amp;</span> highfreq<span class="br0">)</span> 
 
  <span class="kw1">if</span> <span class="br0">(</span>measureCount <span class="sy1">&gt;</span> FORCE_TRANSMIT_INTERVAL<span class="br0">)</span> <span class="br0">{</span> <span class="co1">// force a transmission</span>
    forceTransmit <span class="sy1">=</span> <span class="kw2">true</span><span class="sy4">;</span> 
    measureCount <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
  <span class="br0">}</span>
 
  gw.<span class="me1">process</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
 
  sendTempHumidityMeasurements<span class="br0">(</span>forceTransmit<span class="br0">)</span><span class="sy4">;</span>
  <span class="kw1">if</span> <span class="br0">(</span>sendBattery <span class="sy1">&gt;</span> <span class="nu0">60</span><span class="br0">)</span> 
  <span class="br0">{</span>
     sendBattLevel<span class="br0">(</span>forceTransmit<span class="br0">)</span><span class="sy4">;</span> <span class="co1">// Not needed to send battery info that often</span>
     sendBattery <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
  <span class="br0">}</span>
 
  gw.<span class="me1">sleep</span><span class="br0">(</span>MEASURE_INTERVAL<span class="br0">)</span><span class="sy4">;</span>  
<span class="br0">}</span>
<span class="coMULTI">/*********************************************
 * Sends temperature and humidity sensor
 *
 * Parameters
 * - force : Forces transmission of a value (even if it's the same as previous measurement)
 *********************************************/</span>
<span class="kw4">void</span> sendTempHumidityMeasurements<span class="br0">(</span><span class="kw4">bool</span> force<span class="br0">)</span>
<span class="br0">{</span>
  <span class="kw4">bool</span> tx <span class="sy1">=</span> force<span class="sy4">;</span>
 
    <span class="co1">//get the Temperature from the onboard sensor.</span>
  <span class="kw4">float</span> temp <span class="sy1">=</span> myHumidity.<span class="me1">readTemperature</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
  <span class="kw4">int</span> humidity <span class="sy1">=</span> myHumidity.<span class="me1">readHumidity</span><span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
 
  raHum.<span class="me1">addValue</span><span class="br0">(</span>humidity<span class="br0">)</span><span class="sy4">;</span>
 
  <span class="kw4">float</span> diffTemp <span class="sy1">=</span> <span class="kw3">abs</span><span class="br0">(</span>lastTemperature <span class="sy2">-</span> temp<span class="br0">)</span><span class="sy4">;</span>
  <span class="kw4">float</span> diffHum <span class="sy1">=</span> <span class="kw3">abs</span><span class="br0">(</span>lastHumidity <span class="sy2">-</span> raHum.<span class="me1">getAverage</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span>
 
  <span class="kw2">Serial</span>.<span class="kw3">print</span><span class="br0">(</span>F<span class="br0">(</span><span class="st0">"TempDiff :"</span><span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span><span class="kw2">Serial</span>.<span class="kw3">println</span><span class="br0">(</span>diffTemp<span class="br0">)</span><span class="sy4">;</span>
  <span class="kw2">Serial</span>.<span class="kw3">print</span><span class="br0">(</span>F<span class="br0">(</span><span class="st0">"HumDiff  :"</span><span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span><span class="kw2">Serial</span>.<span class="kw3">println</span><span class="br0">(</span>diffHum<span class="br0">)</span><span class="sy4">;</span> 
 
  <span class="kw1">if</span> <span class="br0">(</span>isnan<span class="br0">(</span>diffHum<span class="br0">)</span><span class="br0">)</span> tx <span class="sy1">=</span> <span class="kw2">true</span><span class="sy4">;</span> 
  <span class="kw1">if</span> <span class="br0">(</span>diffTemp <span class="sy1">&gt;</span> TEMP_TRANSMIT_THRESHOLD<span class="br0">)</span> tx <span class="sy1">=</span> <span class="kw2">true</span><span class="sy4">;</span>
  <span class="kw1">if</span> <span class="br0">(</span>diffHum <span class="sy1">&gt;</span> HUMI_TRANSMIT_THRESHOLD<span class="br0">)</span> tx <span class="sy1">=</span> <span class="kw2">true</span><span class="sy4">;</span>
 
  <span class="kw1">if</span> <span class="br0">(</span>tx<span class="br0">)</span> <span class="br0">{</span>
    measureCount <span class="sy1">=</span> <span class="nu0">0</span><span class="sy4">;</span>
 
    <span class="kw2">Serial</span>.<span class="kw3">print</span><span class="br0">(</span><span class="st0">"T: "</span><span class="br0">)</span><span class="sy4">;</span><span class="kw2">Serial</span>.<span class="kw3">println</span><span class="br0">(</span>temp<span class="br0">)</span><span class="sy4">;</span>
    <span class="kw2">Serial</span>.<span class="kw3">print</span><span class="br0">(</span><span class="st0">"H: "</span><span class="br0">)</span><span class="sy4">;</span><span class="kw2">Serial</span>.<span class="kw3">println</span><span class="br0">(</span>humidity<span class="br0">)</span><span class="sy4">;</span>
 
 <span class="co1">// LED </span>
<span class="co2">#ifdef LED_BLINK_WAIT_TRANSMIT</span>
   <span class="kw3">digitalWrite</span><span class="br0">(</span>LED_PIN, <span class="kw2">HIGH</span><span class="br0">)</span><span class="sy4">;</span>      
    gw.<span class="kw3">send</span><span class="br0">(</span>msgTemp.<span class="me1">set</span><span class="br0">(</span>temp,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span>
    gw.<span class="kw3">send</span><span class="br0">(</span>msgHum.<span class="me1">set</span><span class="br0">(</span>humidity<span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span>
    <span class="kw3">digitalWrite</span><span class="br0">(</span>LED_PIN, <span class="kw2">LOW</span><span class="br0">)</span><span class="sy4">;</span>
 <span class="co2">#else</span>
   gw.<span class="kw3">send</span><span class="br0">(</span>msgTemp.<span class="me1">set</span><span class="br0">(</span>temp,<span class="nu0">1</span><span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span>
   gw.<span class="kw3">send</span><span class="br0">(</span>msgHum.<span class="me1">set</span><span class="br0">(</span>humidity<span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span>
<span class="co2">#endif </span>
    lastTemperature <span class="sy1">=</span> temp<span class="sy4">;</span>
    lastHumidity <span class="sy1">=</span> humidity<span class="sy4">;</span>
    transmission_occured <span class="sy1">=</span> <span class="kw2">true</span><span class="sy4">;</span>
  <span class="br0">}</span>
<span class="br0">}</span>
 
<span class="coMULTI">/********************************************
 *
 * Sends battery information (battery percentage)
 *
 * Parameters
 * - force : Forces transmission of a value
 *
 *******************************************/</span>
<span class="kw4">void</span> sendBattLevel<span class="br0">(</span><span class="kw4">bool</span> force<span class="br0">)</span>
<span class="br0">{</span>
  <span class="kw1">if</span> <span class="br0">(</span>force<span class="br0">)</span> lastBattery <span class="sy1">=</span> <span class="sy2">-</span><span class="nu0">1</span><span class="sy4">;</span>
  <span class="kw4">long</span> vcc <span class="sy1">=</span> readVcc<span class="br0">(</span><span class="br0">)</span><span class="sy4">;</span>
  <span class="kw1">if</span> <span class="br0">(</span>vcc <span class="sy3">!</span><span class="sy1">=</span> lastBattery<span class="br0">)</span> <span class="br0">{</span>
    lastBattery <span class="sy1">=</span> vcc<span class="sy4">;</span>
 
<span class="co2">#ifdef BATT_SENSOR</span>
    gw.<span class="kw3">send</span><span class="br0">(</span>msgBatt.<span class="me1">set</span><span class="br0">(</span>vcc<span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span>
<span class="co2">#endif</span>
 
  <span class="co1">// Calculate percentage</span>
    vcc <span class="sy1">=</span> vcc <span class="sy2">-</span> <span class="nu0">1900</span><span class="sy4">;</span> <span class="co1">// subtract 1.9V from vcc, as this is the lowest voltage we will operate at</span>
 
    <span class="kw4">long</span> percent <span class="sy1">=</span> vcc <span class="sy2">/</span> <span class="nu16">14.0</span><span class="sy4">;</span>
    gw.<span class="me1">sendBatteryLevel</span><span class="br0">(</span>percent<span class="br0">)</span><span class="sy4">;</span>
    transmission_occured <span class="sy1">=</span> <span class="kw2">true</span><span class="sy4">;</span>
  <span class="br0">}</span>
<span class="br0">}</span>
 
<span class="coMULTI">/*******************************************
 *
 * Internal battery ADC measuring 
 *
 *******************************************/</span>
<span class="kw4">long</span> readVcc<span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
  <span class="co1">// Read 1.1V reference against AVcc</span>
  <span class="co1">// set the reference to Vcc and the measurement to the internal 1.1V reference</span>
  <span class="co2">#if defined(__AVR_ATmega32U4__) || defined(__AVR_ATmega1280__) || defined(__AVR_ATmega2560__)</span>
    ADMUX <span class="sy1">=</span> _BV<span class="br0">(</span>REFS0<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX4<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX3<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX2<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX1<span class="br0">)</span><span class="sy4">;</span>
  <span class="co2">#elif defined (__AVR_ATtiny24__) || defined(__AVR_ATtiny44__) || defined(__AVR_ATtiny84__)</span>
    ADMUX <span class="sy1">=</span> _BV<span class="br0">(</span>MUX5<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX0<span class="br0">)</span><span class="sy4">;</span>
  <span class="co2">#elif defined (__AVR_ATtiny25__) || defined(__AVR_ATtiny45__) || defined(__AVR_ATtiny85__)</span>
    ADcdMUX <span class="sy1">=</span> _BV<span class="br0">(</span>MUX3<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX2<span class="br0">)</span><span class="sy4">;</span>
  <span class="co2">#else</span>
    ADMUX <span class="sy1">=</span> _BV<span class="br0">(</span>REFS0<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX3<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX2<span class="br0">)</span> <span class="sy3">|</span> _BV<span class="br0">(</span>MUX1<span class="br0">)</span><span class="sy4">;</span>
  <span class="co2">#endif  </span>
 
  <span class="kw3">delay</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span><span class="sy4">;</span> <span class="co1">// Wait for Vref to settle</span>
  ADCSRA <span class="sy3">|</span><span class="sy1">=</span> _BV<span class="br0">(</span>ADSC<span class="br0">)</span><span class="sy4">;</span> <span class="co1">// Start conversion</span>
  <span class="kw1">while</span> <span class="br0">(</span>bit_is_set<span class="br0">(</span>ADCSRA,ADSC<span class="br0">)</span><span class="br0">)</span><span class="sy4">;</span> <span class="co1">// measuring</span>
 
  uint8_t low  <span class="sy1">=</span> ADCL<span class="sy4">;</span> <span class="co1">// must read ADCL first - it then locks ADCH  </span>
  uint8_t high <span class="sy1">=</span> ADCH<span class="sy4">;</span> <span class="co1">// unlocks both</span>
 
  <span class="kw4">long</span> result <span class="sy1">=</span> <span class="br0">(</span>high<span class="sy1">&lt;&lt;</span><span class="nu0">8</span><span class="br0">)</span> <span class="sy3">|</span> low<span class="sy4">;</span>
 
  result <span class="sy1">=</span> <span class="nu0">1125300L</span> <span class="sy2">/</span> result<span class="sy4">;</span> <span class="co1">// Calculate Vcc (in mV); 1125300 = 1.1*1023*1000</span>
  <span class="kw1">return</span> result<span class="sy4">;</span> <span class="co1">// Vcc in millivolts</span>
 
<span class="br0">}</span></pre></div></div>
<h2> Version Tracker</h2>
<table border="1" cellpadding="5" cellspacing="0">
<tr>
<td width="150"> <b>Revision</b>
</td>
<td width="450"> <b>Description</b>
</td>
<td width="80"> <b>Release</b>
</td></tr>
<tr style="font-size: 90%">
<td> 4.0b
</td>
<td> Prototype
</td>
<td> 01.11.2014
</td></tr>
<tr style="font-size: 90%">
<td> 4.0 rev 1
</td>
<td> Public version
</td>
<td> 22.12.2014
</td></tr></table>
<h2>  Areas of application </h2>
<ul><li> Weather station sensors (basic functionality)
</li><li> Collect data with pulse sensors or gas flow (using interrupt (D3 - IRQ1))
</li><li> Universal sensor (with extensions Grove)
</li><li> Data transfer (on a similar device)<br/>
</li></ul>
<h2>  Questions and Answers </h2>
<ul><li>Blog <a href="//devicter.blogspot.ru/2013/12/shield-matrix-sensor-node.html">Sensor Node</a>
</li><li>Ask a question by e-mail support@devicter.ru
</li></ul>
<h2>  How to buy  </h2>
<p>This product can be purchased:<br/>
China (shipping worldwide) <br/>
<a href="http://www.seeedstudio.com/depot/devDuino-Sensor-Node-V4-ATmega-328-Integrated-temperature-humidity-sensor-p-2279.html?cPath=19_22">Seeed store</a> <br/>
<a href="http://www.elecrow.com/devduino-sensor-nodev4-p-1201.html">Elecrow store</a> <br/>
Russia <br/>
<a href="http://devicter.ru/goods/Sensor-Node-V4">Devicter store</a>
</p>
Copyright (c) 2008-2016 Seeed Development Limited (<a href="http://www.seeedstudio.com">www.seeedstudio.com</a> / <a href="http://www.seeed.cc">www.seeed.cc</a>)<h6>This static html page was created from http://www.seeedstudio.com/wiki</h6></div></body></html>